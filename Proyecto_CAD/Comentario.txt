import { FaStar } from 'react-icons/fa';
import { postUserReview, getUserReview, getReviews, deleteUserReview } from '../service/api';
import { useState, useEffect } from 'react';
import React from 'react';
import './Comentario.css';
import { useUser } from '../contexts/userContext';

const Comentario = ({ isOpen, onClose, bookID }) => {
    if (!isOpen) return null;
    const [rating, setRating] = useState(0);
    const [message, setMessage] = useState('');
    const [reviewText, setReviewText] = useState(''); // Estado para el contenido de la reseña
    const { user } = useUser();
    const [ userReview, setReview] = useState(null); 
    const [ userReviews, setReviews] = useState([]); 
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    console.log('Usuario utilizado desde el modal de resenias', user);

    // Función para manejar la cancelación
    const Cancelar = () => {
        setRating(0); // Reiniciar estrellas
        setReviewText(''); // Limpiar texto de la reseña
        setMessage(''); // Limpiar mensaje
    };

    const obtenerDatos = async () => {
        setLoading(true); //Cargamos las resenias 
        try{
            const [userReviewResponse, reviewsResponse] = await Promise.all([
                getUserReview(user.id, bookID),
                getReviews(bookID)
            ]);

            //Respuestas de las solicitudes a los APIs
            console.log('User Review Response: ', userReviewResponse);
            console.log('Reviews Response: ', reviewsResponse);

            // Comprobar que todas las respuestas son satisfactorias
            if (userReviewResponse.status !== 200 || reviewsResponse.status !== 200) {
                throw new Error('Error en la carga de datos');
            }

            // Establecer los datos en el estado
            setReview(userReviewResponse.data);
            setReviews(reviewsResponse.data || []);
        }catch(error){
            setError(error.message);
        }finally{
            setLoading(false);
        };
    };

    console.log('User Reviews', userReviews);
    useEffect( () => {
        obtenerDatos();
    }, [user.id, bookID]);

    if (loading) return <div>Cargando...</div>;
    if (error) return <div>Error: {error}</div>;

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (rating === 0) {
            setMessage('Por favor, selecciona una calificación de estrellas.');
            return;
        }
        try {
            const respuesta = await postUserReview(user.id, bookID, reviewText, rating);
            setMessage(respuesta.response.data.message || 'Reseña creada exitosamente');
            console.log('Reseña Creada:', respuesta);
            obtenerDatos();
        } catch (error) {
            setMessage('Error al crear reseña');
            console.error('Error al escribir reseña:', error.response ? error.response.data : error.message);
        }
    };

    const Eliminar = async () => {
        try {
            const respuesta = await deleteUserReview(user.id, bookID);
            setMessage(respuesta.response.data.message || 'Reseña eliminada exitosamente');
            console.log('Reseña Eliminada:', respuesta);
            setReviewText('');
            setRating(0);
            obtenerDatos();
        } catch (error) {
            setMessage('Error al eliminar la reseña');
            console.error('Error al eliminar reseña:', error.response ? error.response.data : error.message);
        }
    };

    return (
        <div className="comentario-overlay " onClick={onClose}>
            <div className="comentario-content" onClick={(e) => e.stopPropagation()}>
                <span id="cerrar-comentario" onClick={onClose}>&times;</span>
                {/*empiezo de los contenedores del adentro*/}
                {userReview ? (
                    <div className='comentario-contenedor'>
                    <h1 className='titulo-reseña'>Tu reseña</h1>
                    <div className='usuario-comentario'>
                        <div className='rating'>
                            <i class="bi bi-person-circle" id='circulo-user'></i>
                            <p>{user.nombreUsuario}</p>{/*Aqui viene el nombre del usuario*/}
                            {[...Array(5)].map((star, index) => {
                                const ratingValue = index + 1;
                                return (
                                    <label key={index}>
                                        <input type="radio" name="rating" value={ratingValue} />
                                        <FaStar className="star" color={ratingValue <= userReview.calificacion ? 'gold' : 'darkgray'} size={34} />
                                    </label>
                                );
                            })}
                             {message && <p className="message">{message}</p>}
                        </div>
                        <div className='escribir-contenedor px-5'>
                            <input type="text" className="escribir-control"
                                value={userReview.descripcion} // Valor del estado
                                maxLength= "150"
                                onChange={(e) => setReviewText(e.target.value)} />
                            <div className="botones-contenedor">
                                <button className="btn-cancelar" onClick={Eliminar}>Elminar</button>
                            </div>
                        </div>
                    </div>
                </div>
                ) : (
                    <div className='comentario-contenedor'>
                    <h1 className='titulo-reseña'>Tu reseña</h1>
                    <div className='usuario-comentario'>
                        <div className='rating'>
                            <i class="bi bi-person-circle" id='circulo-user'></i>
                            <p>{user.nombreUsuario}</p>{/*Aqui viene el nombre del usuario*/}
                            {[...Array(5)].map((star, index) => {
                                const ratingValue = index + 1;
                                return (
                                    <label key={index}>
                                        <input type="radio" name="rating" value={ratingValue} onClick={() => setRating(ratingValue)} />
                                        <FaStar className="star" color={ratingValue <= rating ? 'gold' : 'darkgray'} size={34} />
                                    </label>
                                );
                            })}
                             {message && <p className="message">{message}</p>}
                        </div>
                        <div className='escribir-contenedor px-5'>
                            <input type="text" className="escribir-control"
                                placeholder="Escribir Reseña (Opcional)"
                                value={reviewText} // Valor del estado
                                maxLength= "150"
                                onChange={(e) => setReviewText(e.target.value)} />
                            <div className="botones-contenedor">
                                <button className="btn-cancelar" onClick={Cancelar}>Cancelar</button>
                                <button className="btn-publicar" onClick={handleSubmit}>Publicar</button>
                            </div>
                        </div>
                    </div>
                </div>
                ) }
                
                {
                    userReviews.map( (review) => {
                        // Condición para omitir el comentario si el ID coincide con userReview.id
                        if (userReview && userReview.id === review.id) {
                            return null;
                        };

                        return(
                        <div className='comentario-contenedor' key={review.id}>
                            <div className='usuario-comentario'>
                                <div className='rating'>
                                    <i class="bi bi-person-circle" id='circulo-user'></i>
                                    <p>{review.usuario.nombreUsuario}</p>{/*Aqui viene el nombre del usuario*/}
                                    {[...Array(5)].map((star, index) => {
                                        const ratingValue = index + 1;
                                        return (
                                            <label key={index}>
                                            <input type="radio" name="rating" value={ratingValue} />
                                            <FaStar className="star" color={ratingValue <= review.calificacion ? 'gold' : 'darkgray'} size={34} />
                                            </label>
                                        );
                                    })}
                                {message && <p className="message">{message}</p>}
                                </div>

                                <div className='escribir-contenedor px-5'>
                                    <input type="text" className="escribir-control"
                                        value={review.descripcion} // Valor del estado
                                        maxLength= "150"
                                        onChange={(e) => setReviewText(e.target.value)} 
                                    />
                                </div>
                            </div>
                        </div>
                        )
                    
                    })
                }
            </div>
        </div>
    );
};

export default Comentario;
